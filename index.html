<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¯•ä¸šè¢é¢†å–æŸ¥è¯¢ç³»ç»Ÿ@HKBUCSSA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background-color: #f7f9fc;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #002d72;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    .container {
      margin: 2rem auto;
      padding: 2rem;
      max-width: 600px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      
    }
    label, input, button {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .copy-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: url('https://cdn-icons-png.flaticon.com/512/60/60990.png') no-repeat center center / contain;
      cursor: pointer;
      margin-left: 6px;
      vertical-align: middle;
    }

    input, button {
      padding: 0.6rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #002d72;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #001a47; }
    .info { background: #e6f0ff; padding: 1rem; border-radius: 8px; display: none; }
    .info p { margin: 0.5rem 0; }
    .warning { color: red; font-weight: bold; }
    .record-section { margin-top: 2rem; background: #fffbe0; padding: 1rem; border-radius: 8px; }
    .record-section h3 { margin-bottom: 1rem; }
    .record-section li {
      display: flex; justify-content: space-between;
      align-items: flex-start; gap: 1rem;
      padding: 0.5rem; border-bottom: 1px dashed #ccc;
    }
    .record-section li button {
      background: crimson; border: none;
      padding: 0.4rem 0.8rem;
      color: white; border-radius: 4px; font-size: 0.85rem;
    }
    button.export { background: #28a745; }
    button.export:hover { background: #1f7d37; }
  </style>
</head>
<body>
  <header>CSSAæ¯•ä¸šè¢é¢†å–æŸ¥è¯¢</header>
  <div class="container">
    <label for="excelFile">ä¸Šä¼  Excel æ–‡ä»¶ï¼š</label>
    <input type="file" id="excelFile" accept=".xlsx" />

    <p id="currentFileName" style="color:green; font-size:0.9rem;"></p>
    <button onclick="clearCachedExcel()" style="background:darkred; color:white; padding:0.5rem; border:none; border-radius:6px;">ğŸ§¹ æ¸…é™¤ç¼“å­˜æ•°æ®</button>


    <label for="studentId">è¯·è¾“å…¥å­¦å·ã€æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯ã€‘ï¼š</label>
    <input type="text" id="studentId" placeholder="ä¾‹å¦‚ï¼š24471690" />
    <button onclick="searchStudent()">æŸ¥è¯¢</button>

    <div id="result" class="info"></div>
    <button id="markReceivedBtn" style="display:none" onclick="markAsReceived()">æ ‡è®°ä¸ºå·²é¢†å–</button>
    <button id="cancelReceivedBtn" style="display:none; background:crimson;" onclick="cancelReceived(currentId)">å–æ¶ˆæ ‡è®°é¢†å–</button>

    <!-- <label for="searchInput">ğŸ” æœç´¢å­¦å·ï¼š</label>
    <input type="text" id="searchInput" placeholder="è¾“å…¥å­¦å·â€¦" oninput="filterStudents()" /> -->

    <label for="searchInput">ğŸ” æœç´¢å­¦å·ã€æŸ¥è¯¢é¢†å–è®°å½•ã€‘ï¼š</label>
    <input type="text" id="searchInput" placeholder="è¾“å…¥å­¦å·â€¦" />
    <button onclick="filterById()">æŸ¥è¯¢</button>


    <label for="colorSelect">ğŸ¨ ç­›é€‰é¢œè‰²ï¼š</label>
    <select id="colorSelect" onchange="filterByColor()">
      <option value="">å…¨éƒ¨é¢œè‰²</option>
    </select>


    <div class="record-section">
      <h3>ğŸ”æŸ¥è¯¢ç»“æœ</h3>
      <ul id="receivedList"></ul>
    </div>

    <div id="colorStats" class="record-section"></div>
    <div id="sizeStats" class="record-section"></div>
    <div id="degreeStats" class="record-section"></div>

    <!-- <canvas id="colorBarChart" height="300" style="margin-top: 1rem;"></canvas> -->


    <button class="export" onclick="exportReceivedList()">ğŸ“¥ å¯¼å‡ºå·²é¢†å–åå•</button>
    <button class="export" onclick="exportUnreceivedList()">ğŸ“¤ å¯¼å‡ºæœªé¢†å–åå•</button>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw7NrHEX0J9d4_0xtqP0LZGuTo3DGwp4hhH6obopmd0bk2JG05o8jFFHapyVUoG_zei4w/exec";
    let studentData = {}, currentId = null, receivedList = [];

    // ä»…åœ¨åˆå§‹åŒ–æˆ–ä¸Šä¼  Excel æ—¶è°ƒç”¨
    async function initReceivedList() {
      const res = await fetch(API_URL);
      receivedList = await res.json();
      receivedMap = new Map(receivedList.map(([id, , time]) => [id.trim(), time]));
      updateColorOptionsAndStats();
      filterStudents(); // åŒæ­¥åˆ·æ–°ç­›é€‰åˆ—è¡¨
    }

    // è‡ªåŠ¨åŠ è½½ç¼“å­˜
    window.addEventListener('DOMContentLoaded', async () => {
      const cached = localStorage.getItem('studentData');
      if (cached) {
        studentData = JSON.parse(cached);
        document.getElementById('currentFileName').textContent = 'ğŸ“¦ å½“å‰ä¸ºç¼“å­˜æ•°æ®';
        alert(`ğŸ“¦ å·²è½½å…¥ ${Object.keys(studentData).length} ä½åŒå­¦æ•°æ®`);
        await initReceivedList();
      }
    });

    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      document.getElementById('currentFileName').textContent = 'âœ… å½“å‰æ–‡ä»¶ï¼š' + file.name;

      const reader = new FileReader();
      reader.onload = function(e) {
        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        studentData = {};
        json.forEach(row => {
          const id = String(row['å­¦å·'] || row[Object.keys(row)[1]]).trim();
          if (!studentData[id]) studentData[id] = [];
          studentData[id].push(row);
        });

        // ğŸ”’ ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
        localStorage.setItem('studentData', JSON.stringify(studentData));

        alert('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±æœ‰ ' + Object.keys(studentData).length + ' ä½åŒå­¦');
        updateReceivedList();
      };
      reader.readAsArrayBuffer(file);
    });

    // è‡ªåŠ¨åŠ è½½ç¼“å­˜æ•°æ®
    // window.addEventListener('DOMContentLoaded', () => {
    //   const cached = localStorage.getItem('studentData');
    //   if (cached) {
    //     studentData = JSON.parse(cached);
    //     document.getElementById('currentFileName').textContent = 'ğŸ“¦ å½“å‰ä¸ºç¼“å­˜æ•°æ®ï¼ˆä¸Šæ¬¡ä¸Šä¼  Excelï¼‰';
    //     alert('ğŸ“¦ å·²è½½å…¥ä¸Šæ¬¡ä¸Šä¼ çš„ Excel æ•°æ®ï¼Œå…± ' + Object.keys(studentData).length + ' ä½åŒå­¦');
    //     updateReceivedList();
    //   }
    // });

    function clearCachedExcel() {
      localStorage.removeItem('studentData');
      studentData = {};
      alert('ğŸ§¹ å·²æ¸…é™¤ç¼“å­˜æ•°æ®ï¼Œè¯·é‡æ–°ä¸Šä¼  Excel');
      location.reload();
    }

    async function fetchReceivedList() {
      const res = await fetch(API_URL);
      return receivedList = await res.json();
    }

    async function markAsReceived() {
      if (!currentId || !studentData[currentId]) return;

      const entries = studentData[currentId];
      const data = entries[0];

      const body = new URLSearchParams({
        id: currentId,
        name: data.åå­— || '',
        phone: data.å†…åœ°æ‰‹æœº || '',
        hkPhone: data.é¦™æ¸¯æ‰‹æœº || '',
        major: data.ä¸“ä¸š || '',
        degree: data.å­¦ä½ || '',
        color: data.é¢œè‰² || '',
        size: data.å°ºç  || '',
        remark: data.å¤‡æ³¨ || ''
      });

      const res = await fetch(API_URL, {
        method: 'POST',
        body: body
      });

      const now = new Date().toISOString();
      receivedList.push([currentId, data.åå­— || '', now]);
      alert('âœ… å·²è®°å½•è¯¥åŒå­¦ä¸ºå·²é¢†å–');
      searchStudent();
      updateColorOptionsAndStats();
    }




    async function cancelReceived(id) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ id: id, _method: "delete" })
        });

        const text = await res.text();
        if (text.includes("deleted")) {
          // âœ… ä» receivedList ä¸­ç§»é™¤è¯¥æ¡
          receivedList = receivedList.filter(([rId]) => String(rId).trim() !== String(id).trim());
          alert("âœ… å·²å–æ¶ˆè¯¥åŒå­¦çš„é¢†å–è®°å½•");
        } else if (text.includes("not found")) {
          alert("âš ï¸ æ‰¾ä¸åˆ°å¯¹åº”è®°å½•ï¼Œå¯èƒ½å·²åˆ é™¤æˆ–å­¦å·ä¸å­˜åœ¨");
        } else {
          alert("âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯å“åº”ï¼š" + text);
        }

        searchStudent();
        updateColorOptionsAndStats();
      } catch (err) {
        alert("âŒ åˆ é™¤å¤±è´¥ï¼Œç½‘ç»œæˆ–ç³»ç»Ÿå¼‚å¸¸ï¼š" + err.message);
        console.error(err);
      }
    }


    function formatToBeijing(timeStr) {
      const date = new Date(timeStr);
      return new Intl.DateTimeFormat('zh-CN', {
        timeZone: 'Asia/Shanghai',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      }).format(date).replace(/\//g, '-');
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('ğŸ“‹ å·²å¤åˆ¶è®¢å•ç¼–å·');
      });
    }

    async function searchStudent() {
      const id = document.getElementById('studentId').value.trim();
      currentId = id;
      const entries = studentData[id];
      const result = document.getElementById('result');

      if (entries && entries.length > 0) {
        let html = '';
        const received = receivedList.find(([i]) => String(i).trim() === String(id).trim());

        entries.forEach((data, index) => {
          const orderId = data.è®¢å•ç¼–å· || '-';
          html += `
            <div style="margin-bottom: 1rem; padding: 0.5rem; border: 1px dashed #ccc; border-radius: 6px;">
              <p><strong>è®°å½• ${index + 1}</strong></p>
              <p><strong>è®¢å•ç¼–å·ï¼š</strong> ${orderId}
              <span class="copy-icon" title="å¤åˆ¶" onclick="copyToClipboard('${orderId}')"></span></p>
              <p><strong>åå­—ï¼š</strong> ${data.åå­— || '-'}</p>
              <p><strong>å†…åœ°ç”µè¯ï¼š</strong> ${data.å†…åœ°æ‰‹æœº || '-'}</p>
              <p><strong>é¦™æ¸¯ç”µè¯ï¼š</strong> ${data.é¦™æ¸¯æ‰‹æœº || '-'}</p>
              <p><strong>å­¦é™¢ï¼š</strong> ${data.å­¦é™¢ || '-'}</p>
              <p><strong>ä¸“ä¸šï¼š</strong> ${data.ä¸“ä¸š || '-'}</p>
              <p><strong>å­¦å·ï¼š</strong> ${id}</p>
              <p><strong>å­¦ä½ï¼š</strong> ${data.å­¦ä½ || '-'}</p>
              <p><strong>å°ºç ï¼š</strong> ${data.å°ºç  || '-'}</p>
              <p><strong>é¢œè‰²ï¼š</strong> ${data.é¢œè‰² || '-'}</p>
              <p><strong>é¢†å–ç‰©å“ï¼š</strong> ${data.é¢†å–ç‰©å“ || '-'}</p>
              ${received ? '<p style="color:green;font-weight:bold;">âœ… å·²é¢†å–</p>' : '<p style="color:gray;">âŒ› æœªé¢†å–</p>'}
              <p>
                <strong>å¤‡æ³¨ï¼š</strong>
                <input type="text" id="remarkInput" placeholder="è¾“å…¥å¤‡æ³¨..." value="${data.å¤‡æ³¨ || ''}" style="width:90%;padding:4px;margin-top:4px;" />
              </p>
              <button onclick="saveRemark('${id}')">ğŸ’¾ ä¿å­˜å¤‡æ³¨</button>
            </div>`;
        });

        result.innerHTML = html;
        document.getElementById('markReceivedBtn').style.display = 'block';
        document.getElementById('cancelReceivedBtn').style.display = received ? 'block' : 'none';
        result.style.display = 'block';
      } else {
        result.innerHTML = `<p style="color:red;">âŒ æœªæ‰¾åˆ°è¯¥å­¦å·ä¿¡æ¯</p>`;
        result.style.display = 'block';
        document.getElementById('markReceivedBtn').style.display = 'none';
        document.getElementById('cancelReceivedBtn').style.display = 'none';
      }
    }



    async function updateReceivedList() {
      await fetchReceivedList();
      updateColorOptionsAndStats();
      filterStudents();
    }


    async function filterById() {
      const id = document.getElementById('searchInput').value.trim();
      const ul = document.getElementById('receivedList');
      ul.innerHTML = '';

      if (!id) return;

      // await initReceivedList();

      const entry = studentData[id];
      const data = Array.isArray(entry) ? entry[0] : entry;

      if (!data) {
        ul.innerHTML = '<li style="color:red;">âŒ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åŒå­¦</li>';
        return;
      }

      const hasReceived = receivedList.find(([rId]) => String(rId).trim() === id);
      const receivedTime = hasReceived ? formatToBeijing(hasReceived[2]) : null;

      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <strong>${id}</strong> â€“ ${data.åå­— || 'æœªå¡«å†™'} â€“ ${data.å­¦é™¢ || 'æœªå¡«å†™'}<br/>
          ğŸ¨ ${data.é¢œè‰² || 'æœªæ ‡æ³¨'}<br/>
          ğŸ“ å¤‡æ³¨ï¼š${data.å¤‡æ³¨ || 'æ— '}<br/>
          <small style="color:${hasReceived ? 'green' : 'gray'};">
            ${hasReceived ? 'âœ… å·²é¢†å– â° ' + receivedTime : 'âŒ› æœªé¢†å–'}
          </small>
        </div>
      `;
      ul.appendChild(li);
    }


    async function filterByColor() {
      const selectedColor = document.getElementById('colorSelect').value;
      const ul = document.getElementById('receivedList');
      ul.innerHTML = ''; // âœ… æ¸…ç©ºä¸‹é¢çš„å­¦ç”Ÿåå•ï¼Œä¸å†å±•ç¤º

      // âœ… åŒæ­¥éšè—å­¦å·æœç´¢ç»“æœåŒºåŸŸ
      document.getElementById('result').style.display = 'none';
      document.getElementById('markReceivedBtn').style.display = 'none';
      document.getElementById('cancelReceivedBtn').style.display = 'none';

      // â—ï¸å¯é€‰ï¼šä½ å¯ä»¥æ·»åŠ ä¸€æ®µè¯´æ˜æ–‡å­—ï¼Œä¾‹å¦‚
      // ul.innerHTML = '<li>ğŸ“Š è¯·æŸ¥çœ‹ä¸Šæ–¹å›¾è¡¨äº†è§£è¯¥é¢œè‰²é¢†å–æƒ…å†µ</li>';

      // ä½ å¯ä»¥é€‰æ‹©æ˜¯å¦è¦åœ¨è¿™é‡Œå†æ¬¡è§¦å‘ç»Ÿè®¡å›¾æ›´æ–°ï¼š
      // updateColorOptionsAndStats();
    }


    async function saveRemark(id) {
      const remark = document.getElementById('remarkInput').value.trim();

      // âœ… æ›´æ–°æœ¬åœ°ç¼“å­˜
      if (studentData[id]) {
        studentData[id].forEach(entry => {
          entry.å¤‡æ³¨ = remark;
        });
        localStorage.setItem('studentData', JSON.stringify(studentData));
      }

      // âœ… å‘ç»™åç«¯åŒæ­¥
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            id,
            remark,
            _method: "remark"
          })
        });

        const text = await res.text();
        if (text.includes("updated")) {
          alert("âœ… å¤‡æ³¨å·²æˆåŠŸåŒæ­¥åˆ°åç«¯");
        } else {
          alert("âš ï¸ æœ¬åœ°å·²ä¿å­˜ï¼Œä½†åç«¯æœªè¿”å›æˆåŠŸï¼š" + text);
        }
      } catch (err) {
        alert("âŒ ç½‘ç»œå¼‚å¸¸ï¼Œå¤‡æ³¨ä»…ä¿å­˜åœ¨æœ¬åœ°ï¼š" + err.message);
      }
    }




    let colorChartInstance = null;

    function updateColorOptionsAndStats() {
      // const colorMap = {};

      // for (const [id, list] of Object.entries(studentData)) {
      //   list.forEach(data => {
      //     const color = data.é¢œè‰² || 'æœªæ ‡æ³¨';
      //     if (!colorMap[color]) colorMap[color] = { total: 0, received: 0 };
      //     colorMap[color].total++;
      //   });
      // }

      const receivedIdSet = new Set(receivedList.map(([id]) => String(id).trim()));
      const colorMap = {};

      // éå†æ‰€æœ‰è®°å½•ï¼ˆæ¯æ¡ç®—ä¸€ä»¶è¢å­ï¼‰
      for (const [id, entries] of Object.entries(studentData)) {
        entries.forEach(data => {
          const color = data.é¢œè‰² || 'æœªæ ‡æ³¨';
          if (!colorMap[color]) colorMap[color] = { total: 0, received: 0 };
          colorMap[color].total++;

          // âœ… å¦‚æœè¯¥å­¦å·åœ¨å·²é¢†å–åˆ—è¡¨ä¸­ï¼Œè¯¥è®°å½•è®¡ä¸ºâ€œå·²é¢†å–â€
          if (receivedIdSet.has(id)) {
            colorMap[color].received++;
          }
        });
      }


      // ä¸‹æ‹‰èœå•
      const select = document.getElementById("colorSelect");
      select.innerHTML = `<option value="">å…¨éƒ¨é¢œè‰²</option>`;
      Object.keys(colorMap).forEach(color => {
        const option = document.createElement("option");
        option.value = color;
        option.textContent = `${color}`;
        select.appendChild(option);
      });

      // æ˜¾ç¤ºæ–‡å­—ç»Ÿè®¡
      let statHTML = '<h3>ğŸ¯ é¢œè‰²ç»Ÿè®¡</h3><ul>';
      for (const color in colorMap) {
        const { total, received } = colorMap[color];
        statHTML += `<li><strong>${color}</strong>ï¼šå…± ${total} äººï¼Œâœ… ${received} å·²é¢†å–ï¼ŒâŒ› ${total - received} æœªé¢†å–</li>`;
      }
      statHTML += '</ul>';
      document.getElementById('colorStats').innerHTML = statHTML;

      // ğŸ“ å°ºç ç»Ÿè®¡
      const sizeMap = {};
      for (const [id, entries] of Object.entries(studentData)) {
        entries.forEach(data => {
          const size = data.å°ºç  || 'æœªæ ‡æ³¨';
          if (!sizeMap[size]) sizeMap[size] = { total: 0, received: 0 };
          sizeMap[size].total++;
          if (receivedIdSet.has(id)) sizeMap[size].received++;
        });
      }

      // ğŸ“ å­¦ä½ç»Ÿè®¡
      const degreeMap = {};
      for (const [id, entries] of Object.entries(studentData)) {
        entries.forEach(data => {
          const degree = data.å­¦ä½ || 'æœªæ ‡æ³¨';
          if (!degreeMap[degree]) degreeMap[degree] = { total: 0, received: 0 };
          degreeMap[degree].total++;
          if (receivedIdSet.has(id)) degreeMap[degree].received++;
        });
      }

      let degreeHTML = '<h3>ğŸ“ å­¦ä½ç»Ÿè®¡</h3><ul>';
      for (const degree in degreeMap) {
        const { total, received } = degreeMap[degree];
        degreeHTML += `<li><strong>${degree}</strong>ï¼šå…± ${total} äººï¼Œâœ… ${received} å·²é¢†å–ï¼ŒâŒ› ${total - received} æœªé¢†å–</li>`;
      }
      degreeHTML += '</ul>';
      document.getElementById('degreeStats').innerHTML = degreeHTML;


      let sizeHTML = '<h3>ğŸ“ å°ºç ç»Ÿè®¡</h3><ul>';
      for (const size in sizeMap) {
        const { total, received } = sizeMap[size];
        sizeHTML += `<li><strong>${size}</strong>ï¼šå…± ${total} äººï¼Œâœ… ${received} å·²é¢†å–ï¼ŒâŒ› ${total - received} æœªé¢†å–</li>`;
      }
      sizeHTML += '</ul>';
      document.getElementById('sizeStats').innerHTML = sizeHTML;


      // å›¾è¡¨éƒ¨åˆ†
      const labels = Object.keys(colorMap);
      const totalData = labels.map(c => colorMap[c].total);
      const receivedData = labels.map(c => colorMap[c].received);
      const unreceivedData = labels.map(c => colorMap[c].total - colorMap[c].received);

      if (colorChartInstance) colorChartInstance.destroy(); // é˜²æ­¢é‡å¤å›¾å±‚

      const ctx = document.getElementById('colorBarChart').getContext('2d');
      colorChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'æ€»äººæ•°',
              data: totalData,
              backgroundColor: 'rgba(0,123,255,0.4)'
            },
            {
              label: 'å·²é¢†å–',
              data: receivedData,
              backgroundColor: 'rgba(40,167,69,0.6)'
            },
            {
              label: 'æœªé¢†å–',
              data: unreceivedData,
              backgroundColor: 'rgba(220,53,69,0.6)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'ğŸ“ ä¸åŒé¢œè‰²æ¯•ä¸šè¢é¢†å–æƒ…å†µåˆ†å¸ƒå›¾'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              stepSize: 1
            }
          }
        }
      });
    }


    // ä¿®æ”¹ filterStudents å‡½æ•°ï¼Œå¢åŠ é¢œè‰²è¿‡æ»¤é€»è¾‘
    async function filterStudents() {
      const keyword = document.getElementById('searchInput').value.trim();
      const selectedColor = document.getElementById('colorSelect').value;
      const ul = document.getElementById('receivedList');
      ul.innerHTML = '';

      await initReceivedList();

      const receivedMap = new Map(receivedList.map(([id, , time]) => [id.trim(), time]));

      const fragment = document.createDocumentFragment();

      for (const [id, entries] of Object.entries(studentData)) {
        if (keyword && !id.includes(keyword)) continue;

        for (const data of entries) {
          if (selectedColor && data.é¢œè‰² !== selectedColor) continue;

          const hasReceived = receivedMap.has(id);
          const receivedTime = hasReceived ? formatToBeijing(receivedMap.get(id)) : null;

          const li = document.createElement('li');
          li.innerHTML = `
            <div>
              <strong>${id}</strong> - ${data.åå­— || ''} - ${data.å­¦é™¢ || ''}<br/>
              ğŸ¨ ${data.é¢œè‰² || 'æœªæ ‡æ³¨'}<br/>
              <small style="color:${hasReceived ? 'green' : 'gray'};">
                ${hasReceived ? 'âœ… å·²é¢†å– â° ' + receivedTime : 'âŒ› æœªé¢†å–'}
              </small>
            </div>
          `;
          fragment.appendChild(li);
        }
      }

      if (!fragment.children.length) {
        const li = document.createElement('li');
        li.innerHTML = '<span style="color:red;font-weight:bold;">âŒ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åŒå­¦</span>';
        ul.appendChild(li);
      } else {
        ul.appendChild(fragment);
      }
    }



    // æ¯æ¬¡ Excel ä¸Šä¼  & æ•°æ®æ›´æ–°æ—¶è§¦å‘é¢œè‰²åˆ·æ–°
    document.getElementById('excelFile').addEventListener('change', function () {
      setTimeout(updateColorOptionsAndStats, 500);
    });

    async function updateReceivedList() {
      receivedList = await initReceivedList();
      updateColorOptionsAndStats(); // æ›´æ–°ç»Ÿè®¡
      filterStudents(); // é‡æ–°ç­›é€‰ä¸€æ¬¡å±•ç¤º
    }

    async function exportReceivedList() {
      const data = await fetchReceivedList();
      const headers = ['å­¦å·', 'åå­—', 'é¢†å–æ—¶é—´','å†…åœ°æ‰‹æœº','é¦™æ¸¯æ‰‹æœº','ä¸“ä¸š','å­¦ä½','é¢œè‰²','å°ºç ','å¤‡æ³¨'];
      const rows = [headers, ...data];

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'å·²é¢†å–åå•');
      XLSX.writeFile(wb, 'é¢†å–åå•.xlsx');
    }

    async function exportUnreceivedList() {
      const received = await fetchReceivedList();
      const receivedIds = new Set(received.map(([id]) => String(id).trim()));

      const unreceived = Object.entries(studentData)
        .filter(([id]) => !receivedIds.has(String(id).trim()))
        .map(([id, list]) => {
          const data = list[0]; // âœ… å–ç¬¬ä¸€æ¡è®°å½•
          return [
            id,
            data.åå­— || '',
            data.å†…åœ°æ‰‹æœº || '',
            data.é¦™æ¸¯æ‰‹æœº || '',
            data.å­¦é™¢ || '',
            data.ä¸“ä¸š || '',
            data.å­¦ä½ || '',
            data.å°ºç  || '',
            data.é¢œè‰² || '',
            data.é¢†å–ç‰©å“ || ''

          ];
        });

      if (unreceived.length === 0) {
        alert('ğŸ‰ æ‰€æœ‰å­¦ç”Ÿéƒ½å·²é¢†å–ï¼Œæ— éœ€å¯¼å‡ºæœªé¢†å–åå•');
        return;
      }

      const headers = ['å­¦å·', 'åå­—', 'å†…åœ°æ‰‹æœº','é¦™æ¸¯æ‰‹æœº','å­¦é™¢', 'ä¸“ä¸š', 'å­¦ä½', 'å°ºç ', 'é¢œè‰²','é¢†å–ç‰©å“'];
      const rows = [headers, ...unreceived];

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'æœªé¢†å–åå•');
      XLSX.writeFile(wb, 'æœªé¢†å–åå•.xlsx');
    }


    updateReceivedList();

  </script>
</body>
</html>